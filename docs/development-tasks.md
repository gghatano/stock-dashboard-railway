# 開発タスク一覧

## 概要

株価ダッシュボードに米国株（S&P500、FANG+）とドル円レート機能を追加し、ドル建て/円建て表示の切り替えを実装する。

## 機能要件

1. **S&P500指数の表示** - 米国株式市場の主要指数を表示
2. **FANG+の表示** - FANG+インデックスまたは主要銘柄の表示
3. **ドル円レート取得** - リアルタイムの為替レート取得
4. **通貨表示切り替え** - ドル建て/円建てをUIスイッチで切り替え
5. **既存日本株との統合** - 日本株は円建てのみ、米国株は両方表示可能

## フェーズ別タスク

### Phase 1: データ取得基盤の拡張 ✓ (前提条件クリア)

**状態**: 完了
- [x] yfinance 1.0にアップグレード済み
- [x] 10日間データ取得機能実装済み
- [x] 線グラフ表示実装済み

---

### Phase 2: ドル円レート取得機能の追加

**目的**: 為替レートを取得してキャッシュする

**実装内容**:
1. `app.py`にドル円レート取得関数を追加
   - ティッカー: `USDJPY=X`
   - キャッシュ機構を利用（既存と同じTTL）

2. グローバル状態にドル円レートを保持
   - 各リクエストで最新のレートを取得
   - APIレスポンスに含める

**成果物**:
- `get_exchange_rate()` 関数
- `/api/exchange-rate` エンドポイント（オプション）

**見積もり**: 30分

---

### Phase 3: S&P500インデックスの追加

**目的**: S&P500指数をダッシュボードに表示

**実装内容**:
1. `app.py`の`STOCKS`辞書を拡張
   - 新しいデータ構造: ティッカー、名前、**通貨種別（JPY/USD）**
   - S&P500のティッカー: `^GSPC`

2. データモデルの拡張
   - `get_stock_data()`に通貨情報を追加
   - 返り値に`currency`フィールドを追加

3. UI表示の対応
   - USD銘柄には`$`マーク
   - JPY銘柄には`¥`マーク

**成果物**:
- S&P500がダッシュボードに表示される（ドル建て）

**見積もり**: 1時間

---

### Phase 4: FANG+の追加

**目的**: FANG+関連銘柄を表示

**実装方針**:
FANG+インデックスティッカーは存在しないため、以下の選択肢から選ぶ：

**オプションA: FANG+構成銘柄の平均**
- 主要銘柄: META, AAPL, AMZN, NFLX, GOOGL, NVDA, TSLA, MSFT
- 8銘柄の平均価格または時価総額加重平均を計算

**オプションB: FANG+ ETF**
- ティッカー: なし（FANG+ ETFは限定的）
- 代替: `QQQ`（NASDAQ-100 ETF）または個別銘柄

**オプションC: 主要銘柄を個別表示**
- Meta (META), Apple (AAPL), Amazon (AMZN), Netflix (NFLX) などを個別カードで表示

**推奨**: オプションC（個別表示）
- 理由: データ取得が確実、各銘柄の動きが分かりやすい

**実装内容**:
1. FANG+主要銘柄を`STOCKS`に追加（4-8銘柄）
2. グリッドレイアウトの調整（2列→3列または4列）

**成果物**:
- FANG+主要銘柄がダッシュボードに表示される

**見積もり**: 1時間

---

### Phase 5: 円建て換算表示機能

**目的**: 米国株を円建てで表示できるようにする

**実装内容**:
1. フロントエンド状態管理
   - 通貨表示モード: `USD` or `JPY`
   - デフォルト: `USD`

2. データ変換ロジック
   - USD銘柄の価格 × ドル円レート = 円建て価格
   - `change`, `change_percent`も換算

3. APIの拡張
   - `/api/stocks`レスポンスに為替レート情報を含める
   - クライアント側で換算計算

**成果物**:
- データに為替レート情報が含まれる
- フロントエンドで換算可能な状態

**見積もり**: 1.5時間

---

### Phase 6: 通貨切り替えUIの実装

**目的**: ユーザーがドル/円表示を切り替えられるようにする

**実装内容**:
1. トグルスイッチUIの追加
   - 位置: ヘッダー部分（手動更新ボタンの近く）
   - デザイン: Tailwind CSSのトグルスイッチ
   - ラベル: 「USD」「JPY」

2. JavaScript/HTMXでの状態管理
   - トグル切り替え時に表示価格を再計算
   - ローカルストレージに設定を保存（オプション）

3. 価格表示の動的更新
   - USD→JPY: `price × exchange_rate`
   - JPY→JPY: そのまま表示
   - 通貨マークの切り替え: `$` ⇄ `¥`

**UIモック**:
```
┌─────────────────────────────────────────┐
│  株価ダッシュボード          [USD|JPY]  │
│                      [手動更新] [ヘルス] │
└─────────────────────────────────────────┘
```

**成果物**:
- トグルスイッチで通貨表示を切り替え可能

**見積もり**: 2時間

---

### Phase 7: UIレイアウトの最適化

**目的**: 銘柄数増加に対応したレイアウト調整

**実装内容**:
1. グリッドレイアウトの変更
   - 現在: `grid-cols-1 md:grid-cols-2`
   - 変更後: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`
   - 大画面では3列表示

2. カードサイズの最適化
   - 横幅を調整して見やすく
   - チャートサイズの調整

3. 銘柄のグルーピング（オプション）
   - セクション1: 日本株
   - セクション2: 米国インデックス
   - セクション3: FANG+個別銘柄

**成果物**:
- 多数の銘柄が見やすく配置される

**見積もり**: 1時間

---

### Phase 8: テストとバグ修正

**目的**: 全機能の動作確認と品質保証

**テスト項目**:
1. データ取得
   - [ ] ドル円レートが正しく取得できる
   - [ ] S&P500データが正しく取得できる
   - [ ] FANG+データが正しく取得できる
   - [ ] エラー時のフォールバック動作

2. 通貨換算
   - [ ] USD→JPY換算が正しい
   - [ ] 前日比・騰落率が正しく換算される
   - [ ] チャートデータも換算される

3. UI/UX
   - [ ] トグルスイッチが正常に動作
   - [ ] 通貨マークが正しく表示される
   - [ ] HTMX自動更新が正常に動作
   - [ ] レスポンシブデザインの確認

4. パフォーマンス
   - [ ] キャッシュが正常に動作
   - [ ] ページロード時間が許容範囲内
   - [ ] メモリ使用量が適切

**成果物**:
- バグフリーな状態
- `test_app.py`の更新

**見積もり**: 2時間

---

### Phase 9: ドキュメント更新

**目的**: 変更内容をドキュメントに反映

**更新対象**:
1. `README.md`
   - 新機能の説明
   - スクリーンショットの更新（オプション）

2. `CLAUDE.md`
   - 新しいアーキテクチャの説明
   - 通貨換算ロジックの説明
   - FANG+銘柄リスト

3. `doc/api-spec.md`（新規作成）
   - APIエンドポイントの仕様
   - データ構造の詳細

**見積もり**: 1時間

---

## 総見積もり時間

- Phase 2: 0.5時間
- Phase 3: 1時間
- Phase 4: 1時間
- Phase 5: 1.5時間
- Phase 6: 2時間
- Phase 7: 1時間
- Phase 8: 2時間
- Phase 9: 1時間

**合計: 約10時間**

---

## 技術的考慮事項

### 為替レート取得

**ティッカーシンボル**:
- `USDJPY=X` - Yahoo Financeの為替ペア

**取得頻度**:
- 既存と同じキャッシュTTL（30秒）

### S&P500

**ティッカーシンボル**:
- `^GSPC` - S&P 500 Index

**特徴**:
- インデックスのため出来高は意味が薄い
- ポイント単位の表示

### FANG+銘柄候補

| ティッカー | 銘柄名 |
|-----------|--------|
| META | Meta Platforms |
| AAPL | Apple |
| AMZN | Amazon |
| NFLX | Netflix |
| GOOGL | Alphabet (Google) |
| NVDA | NVIDIA |
| TSLA | Tesla |
| MSFT | Microsoft |

**推奨**: 4-6銘柄を選択（画面の見やすさのため）

---

## データ構造の変更

### 現在の`STOCKS`辞書

```python
STOCKS = {
    "2327.T": "日鉄ソリューションズ",
    "4528.T": "小野薬品工業"
}
```

### 変更後の`STOCKS`辞書

```python
STOCKS = {
    "2327.T": {"name": "日鉄ソリューションズ", "currency": "JPY", "type": "stock"},
    "4528.T": {"name": "小野薬品工業", "currency": "JPY", "type": "stock"},
    "^GSPC": {"name": "S&P 500", "currency": "USD", "type": "index"},
    "META": {"name": "Meta", "currency": "USD", "type": "stock"},
    "AAPL": {"name": "Apple", "currency": "USD", "type": "stock"},
    # ...
}
```

### 拡張された株価データ構造

```python
{
    "ticker": "^GSPC",
    "name": "S&P 500",
    "currency": "USD",  # 新規
    "type": "index",    # 新規
    "current_price": 4783.23,
    "change": 15.50,
    "change_percent": 0.32,
    "volume": 0,  # インデックスの場合は0または非表示
    "chart_data": [...],
    "last_update": "2026-01-15 22:00:00",
    "error": false
}
```

### APIレスポンスの拡張

```python
{
    "stocks": [...],
    "exchange_rate": 147.52,  # 新規: ドル円レート
    "timestamp": "2026-01-15T22:00:00+09:00"
}
```

---

## 次のステップ

1. Phase 2から順番に実装開始
2. 各フェーズ完了後に動作確認
3. 問題があれば即座に修正

準備ができたらPhase 2の実装を開始します。
